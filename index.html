<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>æŒ‡ä»¤é›†</title>

<!-- â˜… å¡«å…¥ä½ çš„ Supabase é…ç½® â˜… -->
<script>
  window.SUPABASE_URL  = 'https://hrgottdtlnihablruxtr.supabase.co';
  window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyZ290dGR0bG5paGFibHJ1eHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMTcxOTAsImV4cCI6MjA4Njg5MzE5MH0.6Ng0E96W8VLnATqWgc_o7xVKCrzlewn0J-ba2ChpcE4';
  window.EDIT_PASSWORD = 'your_password_here'; /* â† æ”¹æˆä½ æƒ³è¦çš„å¯†ç  */
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å…¨å±€å˜é‡ & é‡ç½®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#0f1117;--panel:#1a1d2e;--border:#2d3048;
  --accent:#7c83f7;--green:#27ae60;--red:#e74c3c;--amber:#f39c12;
  --ib:#252840;--ibr:#3d4166;--text:#e8eaed;--muted:#667788;
  --topbar-h:50px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

/* â”€â”€ App shell â”€â”€ */
#app{display:flex;height:100%;flex-direction:column}

/* â”€â”€ Topbar â”€â”€ */
#topbar{
  display:flex;align-items:center;gap:10px;
  padding:0 14px;height:var(--topbar-h);
  background:var(--panel);border-bottom:1px solid var(--border);
  flex-shrink:0;z-index:100;
}
#sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:background .3s}
#sync-dot.syncing{background:var(--amber);animation:pulse .8s infinite}
#sync-dot.ok{background:var(--green)}
#sync-dot.err{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

#lock-btn{
  background:transparent;border:1px solid var(--ibr);color:var(--muted);
  padding:5px 12px;border-radius:7px;cursor:pointer;font-size:12px;white-space:nowrap;
}
#lock-btn.unlocked{color:var(--green);border-color:var(--green)}
#lock-btn:hover{border-color:var(--accent);color:var(--accent)}

/* â”€â”€ Main content â”€â”€ */
#main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
#page-root{flex:1;overflow:hidden;display:flex;flex-direction:column}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:7px 14px;border-radius:8px;border:1px solid var(--ibr);cursor:pointer;font-size:13px;font-weight:500;transition:all .15s}
.btn:active{transform:scale(.96)}
.bn{background:var(--ib);color:var(--text)}
.bn:hover{border-color:var(--accent);color:var(--accent)}
.bp{background:var(--accent);color:#fff;border-color:var(--accent)}
.bp:hover{opacity:.85}
.br{background:rgba(231,76,60,.15);color:var(--red);border-color:rgba(231,76,60,.3)}
.br:hover{background:rgba(231,76,60,.25)}
.mbtns{display:flex;gap:8px;align-items:center;margin-top:12px}

/* â”€â”€ Inputs â”€â”€ */
input[type=text],input[type=number],input[type=password],textarea{
  width:100%;padding:8px 11px;border-radius:8px;
  border:1px solid var(--ibr);background:var(--ib);
  color:var(--text);font-size:14px;outline:none;
}
input:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:80px;line-height:1.6}

/* â”€â”€ Password modal â”€â”€ */
#pw-modal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:1000;align-items:center;justify-content:center;
}
#pw-modal.show{display:flex}
#pw-box{
  background:var(--panel);border:1px solid var(--border);border-radius:14px;
  padding:28px;width:min(340px,90vw);
}
#pw-box h2{font-size:16px;margin-bottom:16px}
#pw-box label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
#pw-error{display:none;color:var(--red);font-size:12px;margin-top:6px}

/* â”€â”€ Modal overlay (used by library.js) â”€â”€ */
.tl-modal-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:500;align-items:center;justify-content:center;
}
.tl-modal-overlay.show{display:flex}
.tl-modal{
  background:var(--panel);border:1px solid var(--border);border-radius:14px;
  padding:28px;width:min(520px,92vw);max-height:85vh;overflow-y:auto;
  scrollbar-width:none;
}
.tl-modal::-webkit-scrollbar{display:none}
.tl-modal h2{font-size:16px;font-weight:700;margin-bottom:18px}
.tl-modal label{font-size:12px;color:#888;display:block;margin-bottom:4px}

/* â”€â”€ Expand float btn â”€â”€ */
.expand-btn-float{
  position:absolute;z-index:40;
  width:26px;height:44px;border-radius:8px 0 0 8px;
  border:1px solid var(--border);border-right:none;
  background:var(--panel);color:var(--muted);
  cursor:pointer;font-size:11px;
  opacity:0;pointer-events:none;
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.expand-btn-float.show{opacity:1;pointer-events:auto;}
.expand-btn-float:hover{background:var(--accent);color:#fff;transform:scale(1.1)}
#lib-expand{top:50%;right:0;transform:translateY(-50%)}
#gal-expand{top:50%;right:0;transform:translateY(-50%)}

/* â”€â”€ Toast â”€â”€ */
.toast-item{
  position:fixed;left:50%;transform:translateX(-50%) translateY(8px);
  background:rgba(30,33,55,.97);border:1px solid var(--border);
  color:var(--text);padding:9px 20px;border-radius:10px;
  font-size:13px;z-index:9999;opacity:0;transition:all .25s;
  white-space:nowrap;pointer-events:none;
}
.toast-item.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ panel-toggle-btn â”€â”€ */
.panel-toggle-btn{
  background:transparent;border:1px solid var(--ibr);color:var(--muted);
  width:24px;height:24px;border-radius:5px;cursor:pointer;
  font-size:10px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:all .15s;
}
.panel-toggle-btn:hover{color:var(--accent);border-color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIBRARY PAGE (æŒ‡ä»¤é›†)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lib-layout{position:relative;height:100%;overflow:hidden}
.lib-main{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;overflow:hidden;padding:20px 28px}
.lib-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.lib-header h2{font-size:20px;font-weight:700;color:var(--accent);margin:0}

.lib-panel{position:absolute;right:0;top:0;bottom:0;z-index:50;width:240px;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:transform .28s cubic-bezier(0.4,0,0.2,1)}
.lib-panel.collapsed{transform:translateX(100%)}
.lib-panel-hdr{padding:11px 14px;font-size:13px;font-weight:700;color:var(--accent);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;flex-shrink:0}
.lib-panel-hdr:hover{background:#22263a}
.lib-panel-body{flex:1;overflow-y:auto;padding:12px 14px}
.lib-panel-body::-webkit-scrollbar{width:3px}
.lib-panel-body::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:2px}

.lib-tag-list{display:flex;flex-direction:column;gap:6px}
.lib-tag-filter{padding:8px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .18s;font-size:13px;background:var(--bg);border:1px solid transparent}
.lib-tag-filter:hover{background:#22263a;border-color:var(--border)}
.lib-tag-filter.selected{background:rgba(124,131,247,.25);color:var(--accent);font-weight:600;border-color:var(--accent);box-shadow:0 0 0 1px rgba(124,131,247,.3)}
.lib-tag-main{flex:1;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.lib-tag-name{flex:1}
.lib-tag-count{color:var(--muted);font-size:11px;margin-left:8px}
.lib-tag-actions{display:flex;gap:4px;margin-left:8px;opacity:0;transition:opacity .15s}
.lib-tag-filter:hover .lib-tag-actions{opacity:1}
.lib-tag-action-btn{width:22px;height:22px;border:none;background:rgba(124,131,247,.15);border-radius:4px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0}
.lib-tag-action-btn:hover{background:rgba(124,131,247,.3);transform:scale(1.1)}
.lib-tag-edit:hover{background:rgba(39,174,96,.25)}
.lib-tag-delete:hover{background:rgba(239,68,68,.25)}

.lib-grid{flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding-bottom:20px;align-items:start}
.lib-grid::-webkit-scrollbar{width:4px}
.lib-grid::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:3px}
.lib-empty{grid-column:1/-1;text-align:center;color:var(--muted);font-size:14px;padding:40px 20px}

.lib-item{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all .18s;user-select:none}
.lib-item:hover{border-color:var(--accent);background:#22263a;transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.lib-item-content{font-size:14px;line-height:1.7;color:#cdd;margin-bottom:10px;white-space:pre-wrap;word-break:break-word}
.lib-item-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.lib-item-tag{font-size:11px;padding:3px 8px;border-radius:12px;background:rgba(124,131,247,.15);color:var(--accent)}

.lib-item-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.05)}
.lib-item-author{font-size:12px;color:#889;font-style:italic}
.lib-item-like{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(124,131,247,.08);border:1px solid rgba(124,131,247,.2);border-radius:8px;cursor:pointer;transition:all .2s;user-select:none}
.lib-item-like:hover{background:rgba(124,131,247,.15);border-color:rgba(124,131,247,.4);transform:translateY(-1px)}
.lib-item-like:active{transform:translateY(0) scale(0.98)}
.lib-item-like.liked{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.4)}
.lib-item-like.liked:hover{background:rgba(239,68,68,.25);border-color:rgba(239,68,68,.6)}
.lib-item-like.liked .lib-like-count{color:#ef4444}
.lib-author-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--bg);border:1px solid var(--border);border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.lib-author-suggestion{padding:8px 12px;cursor:pointer;font-size:13px;transition:background .15s}
.lib-author-suggestion:hover{background:rgba(124,131,247,.15)}
.lib-author-suggestion:active{background:rgba(124,131,247,.25)}
.lib-sort-btn{flex:1;padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:12px;cursor:pointer;transition:all .2s;white-space:nowrap}
.lib-sort-btn:hover{background:rgba(124,131,247,.1);border-color:rgba(124,131,247,.3)}
.lib-sort-btn.active{background:rgba(124,131,247,.2);border-color:var(--accent);color:var(--accent);font-weight:600}
.lib-like-btn{font-size:18px;line-height:1;pointer-events:none}
.lib-like-count{font-size:14px;color:var(--accent);font-weight:600;min-width:24px;text-align:center;pointer-events:none}

.lib-tag-picker{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:var(--bg);border-radius:6px;min-height:40px}
.lib-tag-checkbox{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;cursor:pointer;transition:all .15s;font-size:13px;background:var(--panel);border:1px solid var(--border)}
.lib-tag-checkbox:hover{background:#22263a;border-color:var(--accent)}
.lib-tag-checkbox input[type="checkbox"]{margin:0;cursor:pointer}

/* Tab nav */
#tab-nav{display:flex;gap:4px;margin-right:auto}
.tab-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:6px 16px;border-radius:6px;font-size:13px;font-weight:600;transition:all .15s}
.tab-btn:hover{background:rgba(124,131,247,.1);color:var(--text)}
.tab-btn.active{background:rgba(124,131,247,.18);color:var(--accent)}

/* Gallery grid */
.gal-grid{flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;padding-bottom:20px;align-content:start;align-items:start}
.gal-grid::-webkit-scrollbar{width:4px}
.gal-grid::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:3px}
.gal-item{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:transform .15s,box-shadow .15s}
.gal-item:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.gal-item-img-wrap{width:100%;aspect-ratio:1;overflow:hidden;background:#111}
.gal-item-img{width:100%;height:100%;object-fit:cover;transition:transform .2s}
.gal-item:hover .gal-item-img{transform:scale(1.04)}
.gal-item-title{padding:8px 8px 4px;font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gal-edit-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .18s;color:#fff;font-size:13px;font-weight:600;pointer-events:none}
.gal-item:hover .gal-edit-overlay{opacity:1}

</style>

</head>
<body>

<div id="app">
  <!-- Topbar -->
  <div id="topbar">
    <div id="tab-nav">
      <button class="tab-btn active" data-tab="library">ğŸ“‹ æŒ‡ä»¤é›†</button>
      <button class="tab-btn" data-tab="gallery">ğŸ–¼ å›¾åº“</button>
    </div>
    <div id="sync-dot" title="åŒæ­¥çŠ¶æ€"></div>
    <button id="lock-btn" onclick="showPwModal()">ğŸ”’ ç¼–è¾‘</button>
  </div>

  <div id="main-content">
    <div id="page-root"></div>
  </div>
</div>

<!-- Password modal -->
<div id="pw-modal">
  <div id="pw-box">
    <h2>ğŸ” è¾“å…¥ç¼–è¾‘å¯†ç </h2>
    <label>å¯†ç </label>
    <input id="pw-input" type="password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password"/>
    <div id="pw-error">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
    <div class="mbtns" style="justify-content:flex-end;margin-top:4px">
      <button class="btn bn" onclick="closePwModal()">å–æ¶ˆ</button>
      <button class="btn bp" onclick="submitPw()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script type="module">
import { showToast } from './ui.js';
import { isEditor, tryUnlock, lock, onAuthChange } from './auth.js';
import { mount as mountLibrary, unmount as unmountLibrary } from './library.js';
import { mount as mountGallery, unmount as unmountGallery } from './gallery.js';

// â”€â”€ Auth UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthChange(editor => {
  const btn = document.getElementById('lock-btn');
  if (editor) {
    btn.textContent = 'ğŸ”“ ç¼–è¾‘ä¸­';
    btn.classList.add('unlocked');
  } else {
    btn.textContent = 'ğŸ”’ ç¼–è¾‘';
    btn.classList.remove('unlocked');
  }
});

// â”€â”€ Password modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showPwModal = function() {
  if (isEditor()) { lock(); return; }
  document.getElementById('pw-input').value = '';
  document.getElementById('pw-error').style.display = 'none';
  document.getElementById('pw-modal').classList.add('show');
  setTimeout(() => document.getElementById('pw-input').focus(), 60);
};
window.closePwModal = function() {
  document.getElementById('pw-modal').classList.remove('show');
  document.getElementById('pw-error').style.display = 'none';
  document.getElementById('pw-input').value = '';
};
window.submitPw = function() {
  const pw = document.getElementById('pw-input').value;
  let success = false;
  try {
    success = tryUnlock(pw);
  } catch(e) {
    console.error('[submitPw] error:', e);
    success = true;
  }
  if (success) {
    window.closePwModal();
    showToast('âœ… å·²è§£é”ç¼–è¾‘æ¨¡å¼');
  } else {
    document.getElementById('pw-error').style.display = 'block';
    document.getElementById('pw-input').value = '';
    document.getElementById('pw-input').focus();
  }
};
document.getElementById('pw-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); e.stopPropagation(); window.submitPw(); }
  if (e.key === 'Escape') { e.stopPropagation(); window.closePwModal(); }
});
document.getElementById('pw-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('pw-modal')) window.closePwModal();
});

// â”€â”€ Tab routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const root = document.getElementById('page-root');
let currentTab = 'library';
let unmountCurrent = null;

async function switchTab(tab) {
  if (tab === currentTab && unmountCurrent) return;
  if (unmountCurrent) { try { unmountCurrent(); } catch(e){} }
  currentTab = tab;
  root.innerHTML = '';
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  if (tab === 'library') {
    await mountLibrary(root);
    unmountCurrent = unmountLibrary;
  } else if (tab === 'gallery') {
    await mountGallery(root);
    unmountCurrent = unmountGallery;
  }
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

await switchTab('library');
</script>

</body>
</html>
